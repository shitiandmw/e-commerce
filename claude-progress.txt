## 测试进度记录

### 2026-02-17 Session - 购物车功能 (F175-F176)

开发功能: F175-F176 购物车（共 2 个功能）

#### 开发内容
- 购物车状态管理 (lib/cart.ts + CartProvider)
- 购物车页面 /cart (空状态、商品列表、总计、去结算)
- 商品详情页加购按钮集成
- Header 购物车数量徽章
- Next.js API 代理路由 (解决 CORS)
- 购物车增删改操作 (加购、修改数量、删除、清空)

#### 测试结果
- F175 前台购物车页面 ✅ 通过
  - /cart 页面正常渲染
  - 空状态显示"购物车为空"和"去购物"按钮
  - 商品列表显示图片/名称/变体/单价/数量/小计
  - 总计区域显示小计和总计
  - 去结算按钮正常
- F176 购物车增删改操作 ✅ 通过
  - 商品详情页加购 + Header 数量徽章更新
  - 修改数量实时更新价格和总计
  - 删除商品正常
  - 不同变体分别显示
  - 清空购物车正常

#### 总结
- 2/2 功能全部通过
- 使用 Medusa Store Cart API，通过 Next.js API 路由代理避免 CORS
- 购物车状态通过 React Context 全局管理，localStorage 持久化 cart_id

### 2026-02-16 Session - 弹窗管理模块 (F033-F040)

测试功能: F033-F040 弹窗管理模块（共 8 个功能）

#### 测试结果
- F033 弹窗列表查询 ✅ 直接通过
- F034 弹窗创建 ✅ 直接通过
- F035 弹窗编辑 ✅ 直接通过
- F036 弹窗删除 ✅ 直接通过
- F037 弹窗触发类型配置 ✅ 直接通过
- F038 弹窗频率配置 ✅ 直接通过
- F039 弹窗目标页面配置 ✅ 直接通过
- F040 弹窗素材选择 ✅ 直接通过

#### 总结
- 8/8 功能全部通过，无需代码修复
- 弹窗管理模块功能完整：CRUD、触发类型配置、频率配置、目标页面配置、媒体素材选择
- 所有功能通过浏览器 UI 端到端验证

### 2026-02-16 Session - Banner 管理模块 (F041-F051)

测试功能: F041-F051 Banner 管理模块（共 11 个功能）

#### 测试结果
| Feature | 描述 | 状态 |
|---------|------|------|
| F041 | Banner位列表查询 | ✅ PASS |
| F042 | Banner位创建 | ✅ PASS |
| F043 | Banner位编辑 | ✅ PASS |
| F044 | Banner位删除 | ✅ PASS |
| F045 | Banner项列表查询 | ✅ PASS |
| F046 | Banner项创建 | ✅ PASS (修复了2个bug) |
| F047 | Banner项编辑 | ✅ PASS |
| F048 | Banner项删除 | ✅ PASS |
| F049 | Banner项时间窗配置 | ✅ PASS |
| F050 | Banner项启用禁用 | ✅ PASS |
| F051 | Banner项排序配置 | ✅ PASS |

#### 修复的 Bug
1. `src/api/middlewares.ts`: `GetBannerItemsSchema` 缺少 `slot_id` 字段，导致前端按 slot 过滤 banner items 时报 "Unrecognized fields" 错误
2. `src/api/admin/banner-items/validators.ts`: `PostAdminCreateBannerItem` 的 `starts_at`、`ends_at`、`title`、`subtitle`、`link_url` 字段缺少 `.nullable()`，导致前端发送 null 值时验证失败

#### 总结
- 11/11 功能全部通过
- 修复了 2 个后端验证 bug
- 所有功能通过浏览器 UI 端到端验证

### 2026-02-16 Session - F088~F090 媒体管理模块

测试功能:
- F088 媒体列表接口查询 ✅ 直接通过
- F089 媒体MIME类型识别 ✅ 直接通过
- F090 媒体分页查询 ✅ 直接通过

测试详情:
- F088: GET /admin/uploads API 正确返回文件列表，包含 id/url/name/size/mime_type/created_at 字段，UI 正确显示网格/列表视图
- F089: 验证了 6 种 MIME 类型识别（png→image/png, jpg→image/jpeg, csv→text/csv, pdf→application/pdf, svg→image/svg+xml, txt→text/plain），UI 根据类型显示不同图标
- F090: 验证了分页参数 offset/limit 正确工作，返回 count 总数，边界情况（超出范围返回空数组）处理正确

完成状态: F088-F090 全部通过

### 2026-02-16 Session - 商品管理模块 (F091-F096)

| Feature | 名称 | 状态 | 备注 |
|---------|------|------|------|
| F091 | 商品创建（含变体） | ✅ PASS | 创建商品 F091Test，含默认变体 |
| F092 | 商品编辑 | ✅ PASS | 修改标题为 F091Test-Edited，添加副标题 |
| F093 | 商品分类绑定 | ✅ PASS | 绑定 Shirts 分类，修复了分类绑定需使用独立 API 的问题 |
| F094 | 商品品牌绑定 | ✅ PASS | 绑定 Test Brand Edited，修复了 fields 参数需用 *brand 的问题 |
| F095 | 商品标签绑定 | ✅ PASS | 绑定 测试标签F009，通过 UI 选择并 API 验证 |
| F096 | 商品SEO保存 | ✅ PASS | 填写 meta_title/meta_description/keywords，保存到 metadata.seo 并验证回显 |

#### 代码修复记录
- `use-products.ts`: fields 参数从 `+categories,+brand,+custom_tags` 改为 `*categories,*brand,*custom_tags`（Medusa v2 自定义模块链接需要 * 前缀）
- `use-products.ts`: 新增 `useLinkProductCategory` 和 `useUnlinkProductCategory` hooks
- `product-form.tsx`: 编辑模式下分类/品牌/标签绑定改用独立 API 端点而非产品更新 API

### 2026-02-16 Session - 订单/客户/库存/配送/促销/看板/设置 (F097-F108)

测试结果: 12/12 全部通过

F097 订单列表查询      ✅ PASS
F098 订单详情查看      ✅ PASS
F099 客户列表查询      ✅ PASS
F100 客户详情查看      ✅ PASS
F101 库存列表查询      ✅ PASS
F102 库存调整          ✅ PASS
F103 配送配置页可用    ✅ PASS
F104 促销列表查询      ✅ PASS
F105 促销创建          ✅ PASS (修复了 Zod schema 验证问题)
F106 促销编辑          ✅ PASS
F107 数据看板加载      ✅ PASS
F108 设置页加载        ✅ PASS

修复的 Bug:
1. promotion-form.tsx: allocation 字段 Zod schema 不接受空字符串，导致表单提交静默失败
   - 修改: z.enum(["each","across"]).optional() → z.union([z.enum(["each","across"]), z.literal("")]).optional()
   - 同时确保 API payload 始终发送 allocation 和 max_quantity

### 2026-02-16 Session - F109-F115 后台通用功能A（登录/校验/状态）

#### 测试结果
- F109 后台登录 ✅ 直接通过
- F110 后台登出 ✅ 直接通过
- F111 登录态过期自动跳转 ✅ 直接通过
- F112 后台接口参数校验 ✅ 直接通过
- F113 后台错误提示展示 ✅ 直接通过
- F114 后台空状态展示 ✅ 直接通过
- F115 后台骨架屏展示 ✅ 直接通过

#### 测试详情
- F109: 登录页面正常显示，错误凭据显示"邮箱或密码错误"，正确凭据跳转到 /dashboard
- F110: 点击"退出登录"后跳转到 /login，登出后无法直接访问 dashboard
- F111: 将 token 替换为无效值后，API 返回 401，系统自动清除 token 并跳转到 /login
- F112: 前端表单校验（"Name is required"）和后端 API 校验（"Invalid request: Field 'name' is required"）均正常
- F113: 登录错误提示、表单校验错误、API 错误均有对应的 UI 展示（红色文本/红色背景块）
- F114: 搜索不存在的品牌时显示"暂无品牌。创建您的第一个品牌开始使用。"
- F115: Skeleton 组件使用 animate-pulse 动画，在 57 个组件中广泛使用

#### 完成状态
7/7 功能通过 (100%)，无需代码修复

### 2026-02-16 Session - F116-F120 后台通用功能B（国际化/组件一致性）

#### 测试结果
- F116 后台中英文切换 ✅ 直接通过
  - 中文→英文切换正常，所有侧边栏和按钮文本正确翻译
  - 刷新页面后语言设置持久化（通过 cookie）
  - 英文→中文切换正常

- F117 后台侧边栏导航跳转 ✅ 直接通过
  - 测试了所有 18 个侧边栏导航链接
  - 每个链接都能正确跳转到对应页面（/products, /brands, /orders, /customers, /pages, /settings, /articles, /promotions, /popups, /analytics 等）

- F118 后台表格组件一致性 ✅ 直接通过
  - 商品管理：搜索框、状态筛选、排序（名称/创建时间）、操作菜单、分页
  - 品牌管理：搜索框、排序（名称/创建时间）、操作菜单、分页
  - 订单管理：搜索框、多筛选（状态/支付/物流）、排序（订单/金额/日期）
  - 公告栏管理：排序按钮、开关、编辑/删除按钮
  - 各页面表格组件结构一致

- F119 后台弹窗交互一致性 ✅ 直接通过
  - 商品详情页删除确认弹窗：取消/删除/Close(X) 三个操作
  - 弹窗详情页删除确认弹窗：取消/删除/Close(X) 三个操作
  - 取消按钮和 X 按钮都能正确关闭弹窗
  - 弹窗交互在不同模块中保持一致

- F120 后台富文本工具栏可用性 ✅ 直接通过
  - 文章编辑页面：完整工具栏（Bold/Italic/Underline/Strikethrough/Code/H1-H3/Lists/Blockquote/HR/Alignment/Link/Image/Undo/Redo）
  - 页面创建表单：同样完整的工具栏
  - 所有按钮可点击，Undo 状态正确响应

#### 总结
- 测试功能数: 5
- 直接通过: 5
- 需要修复: 0
- 所有功能均一次通过，无需代码修复

### 2026-02-16 Session - F121-F130 后台样式检查A

#### 测试结果: 10/10 全部通过

| Feature | 功能名称 | 结果 | 备注 |
|---------|---------|------|------|
| F121 | 后台侧边栏视觉一致性 | ✅ 直接通过 | 导航项样式统一，激活/非激活状态清晰 |
| F122 | 后台列表页表格排版一致性 | ✅ 直接通过 | 商品/品牌/订单/文章/客户列表排版一致 |
| F123 | 后台表单页标题与操作区对齐 | ✅ 直接通过 | 商品/文章/Banner表单sticky标题栏对齐 |
| F124 | 后台粘性保存栏视觉稳定性 | ✅ 直接通过 | 滚动时sticky栏稳定，毛玻璃效果正常 |
| F125 | 后台按钮主次层级清晰度 | ✅ 直接通过 | primary/outline/ghost层级清晰 |
| F126 | 后台输入框与标签间距一致性 | ✅ 直接通过 | 表单和对话框中label-input间距统一 |
| F127 | 后台日期时间输入排版 | ✅ 直接通过 | datetime-local输入框排版一致 |
| F128 | 后台开关组件视觉反馈 | ✅ 直接通过 | 开/关状态颜色区分明显 |
| F129 | 后台标签色块与文案对比度 | ✅ 直接通过 | Badge各变体对比度良好 |
| F130 | 后台Banner预览缩略图清晰度 | ✅ 直接通过 | 16:9比例容器+object-cover |

#### 无需修复
所有10个样式检查功能均直接通过，无需代码修复。

### 2026-02-16 Session - 后台样式检查B (F131-F140)

测试功能: F131-F140 后台样式检查B（共 10 个功能）

| Feature | 名称 | 状态 | 备注 |
|---------|------|------|------|
| F131 | 后台文章封面预览样式 | ✅ PASS | 圆角边框、object-cover、max-w-xs |
| F132 | 后台弹窗预览卡片样式 | ✅ PASS | 卡片布局、标题/描述/CTA层次分明 |
| F133 | 后台菜单树缩进与层级可读性 | ✅ PASS | 每层24px缩进、展开/折叠、状态Badge |
| F134 | 后台策展商品卡片信息密度 | ✅ PASS | 缩略图+标题+状态+排序控制 |
| F135 | 后台SEO预览区样式一致性 | ✅ PASS | Google风格预览、字符计数器、暗色模式支持 |
| F136 | 后台错误提示颜色与对比度 | ✅ PASS | text-destructive红色、bg-destructive/10背景 |
| F137 | 后台空状态文案与CTA可见性 | ✅ PASS | 图标+标题+描述文案、text-muted-foreground |
| F138 | 后台加载状态骨架屏一致性 | ✅ PASS | 统一Skeleton组件、20+模块一致使用 |
| F139 | 后台平板端布局可用性 | ✅ PASS | 修复侧边栏nav缺少overflow-y-auto |
| F140 | 后台国际化文案换行与截断表现 | ✅ PASS | 中英文切换布局正常、无截断 |

#### 代码修复记录
- `sidebar.tsx`: nav 添加 `overflow-y-auto`，修复平板端(1024x768)菜单项被截断的问题

#### 总结
- 10/10 功能全部通过
- 修复了 1 个侧边栏布局 bug（F139）
- 其余 9 个功能直接通过视觉验证和代码审查

### 2026-02-16 Session - 前台项目初始化 (F141-F142)

测试功能: F141-F142 前台项目初始化（共 2 个功能）

| Feature | 名称 | 状态 | 备注 |
|---------|------|------|------|
| F141 | 初始化独立前台项目目录storefront | ✅ PASS | Next.js App Router + TS + Tailwind，端口3000 |
| F142 | 前台环境变量校验 | ✅ PASS | Medusa JS SDK 安装配置，服务端+客户端连通 |

#### 实现内容
- 使用 create-next-app 创建 storefront/ 目录（Next.js 16 + TypeScript + Tailwind CSS 4）
- 配置 dev 脚本在端口 3000 启动
- 配置 Tailwind 主题色：深色背景(#0c0c0c) + 金色调(#c9a96e)，参考 timecigar 风格
- 创建 Header 组件（TIMECIGAR logo + 导航 + 购物车/账户）
- 创建 Footer 组件（四列布局：品牌/购物指南/关于/联系）
- 配置 .env.local（NEXT_PUBLIC_MEDUSA_BACKEND_URL=http://localhost:9000）
- 安装 @medusajs/js-sdk，创建 SDK 客户端实例 lib/medusa.ts
- 创建 /test-sdk 测试页面，验证服务端和客户端 SDK 均可连接后端获取商品列表
- 后端(9000)不受影响

#### 总结
- 2/2 功能全部通过
- 无需修复已有代码

### 2026-02-16 Session - Store Content Delivery APIs (F143-F149)

测试功能: F143-F149 Store 内容接口（共 7 个功能）

#### 实现内容
新增 8 个 Store API 路由：
- `GET /store/content/home` - 返回活跃 banners、announcements、popups、curated collections
- `GET /store/content/menus` - 支持 key 查询参数，返回菜单树形结构
- `GET /store/content/articles` - 支持 category/q/offset/limit 参数，仅返回已发布文章
- `GET /store/content/articles/:slug` - 返回单篇已发布文章详情
- `GET /store/content/pages/:slug` - 返回已发布静态页详情
- `GET /store/content/collections` - 支持 key 参数，返回策展集合含 tabs 和 items
- `GET /store/content/brands` - 支持分页和搜索
- `GET /store/content/brands/:handle` - 返回单个品牌详情及关联商品

#### 测试结果
| Feature | 描述 | 状态 |
|---------|------|------|
| F143 | Store 内容接口 /store/content/home | ✅ PASS |
| F144 | Store 内容接口 /store/content/menus | ✅ PASS |
| F145 | Store 内容接口 /store/content/articles | ✅ PASS |
| F146 | Store 内容接口 /store/content/articles/:slug | ✅ PASS |
| F147 | Store 内容接口 /store/content/pages/:slug | ✅ PASS |
| F148 | Store 内容接口 /store/content/collections | ✅ PASS |
| F149 | Store 内容接口 /store/content/brands | ✅ PASS |

#### 验证详情
- F143: 验证了 banners/announcements/popups/collections 四个字段返回、banner 启用/禁用过滤、时间窗过滤
- F144: 验证了 key 参数过滤、树形结构返回、禁用菜单项过滤
- F145: 验证了文章列表、分页(limit/offset)、分类过滤、搜索(q)、草稿文章不返回
- F146: 验证了已发布文章详情、不存在 slug 返回 404、草稿文章 slug 返回 404
- F147: 验证了已发布页面详情、不存在 slug 返回 404、未发布页面返回 404
- F148: 验证了集合列表含 tabs 和 items、key 参数过滤
- F149: 验证了品牌列表、分页、搜索、单品牌详情含关联商品

#### 总结
- 7/7 功能全部通过
- 无需修复已有代码，全部为新增 Store API 路由

### 2026-02-17 Session - 前台认证流程 (F167-F170)

测试功能: F167-F170 前台认证流程（共 4 个功能）

#### 实现内容
- 创建 `lib/auth.ts` 认证库（register/login/logout/requestPasswordReset/getCustomer）
- 更新 Medusa SDK 配置启用 JWT 认证
- 创建 `/register` 注册页面（邮箱+密码+姓名，表单校验，调用 Medusa Store API）
- 创建 `/login` 登录页面（邮箱+密码，支持 redirect 回跳）
- 创建 `/forgot-password` 忘记密码页面（不泄露用户是否存在）
- 创建 `AuthGuard` 组件实现登录拦截（/checkout、/account、/orders）
- 创建 `AuthLayout` 和 `MainLayout` 组件分离认证页面和主站布局
- Header 根据登录状态显示登录/账户+退出

#### 测试结果
| Feature | 描述 | 状态 | 备注 |
|---------|------|------|------|
| F167 | 前台用户注册流程 | ✅ PASS | 表单校验正常，5个字段校验错误正确显示 |
| F168 | 前台用户登录流程 | ✅ PASS | 校验正常，错误登录显示"邮箱或密码错误" |
| F169 | 前台忘记密码流程 | ✅ PASS | 提交后显示"邮件已发送"，不泄露用户存在 |
| F170 | 前台登录拦截与回跳 | ✅ PASS | /checkout→/login?redirect=%2Fcheckout，/account、/orders 同理 |

#### 代码修复记录
- 修复注册页面姓名校验提示错误（firstName/lastName 错误消息互换）
- 修复路由组冲突：移除 (auth)/(main) 路由组，改用 AuthLayout/MainLayout 组件方案

#### 总结
- 4/4 功能全部通过
- 修复了 2 个 bug（校验提示、路由组冲突）

### 2026-02-17 Session - 前后台联调 (F184-F187)

测试功能: F184-F187 前后台联调（共 4 个功能）

#### 实现内容
- F186: 新增 `storefront/src/components/PopupModal.tsx` 弹窗组件
  - 支持 trigger_type: first_visit / every_visit / specific_page
  - 支持 display_frequency: once (localStorage) / once_per_session (sessionStorage) / once_per_day (localStorage+时间戳)
  - 集成到首页 page.tsx
- F187: 修复 home API 和 collections API 中策展集合商品详情获取
  - 问题: `query.graph()` 查询 product 实体在 store 路由上下文中受 publishable key 作用域限制，返回空结果
  - 解决: 改用 `productService.listProducts()` 直接通过产品模块服务查询，绕过 store 作用域限制
  - 修改文件: `src/api/store/content/home/route.ts`, `src/api/store/content/collections/route.ts`

#### 测试结果
| Feature | 描述 | 状态 | 备注 |
|---------|------|------|------|
| F184 | 前台菜单渲染联调 | ✅ PASS | Header 显示 main 菜单，Footer 显示 footer 菜单，禁用项正确隐藏 |
| F185 | 前台 Banner 渲染联调 | ✅ PASS | 5 张 Banner 轮播正常，禁用项正确隐藏 |
| F186 | 前台弹窗渲染联调 | ✅ PASS | 弹窗正确弹出，关闭后频率控制生效（once 模式刷新不再弹出） |
| F187 | 前台策展集合渲染联调 | ✅ PASS | 集合标题/Tab/商品卡片正确渲染，Tab 切换正常 |

#### 总结
- 4/4 功能全部通过
- 修复了 1 个关键 bug（F187 商品详情获取使用 productService 替代 query.graph）
- 新增 1 个组件（PopupModal.tsx）
